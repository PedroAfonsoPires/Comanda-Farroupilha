<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Comanda Farroupilha - PWA</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#166534">
  <style>
    /* Ajustes pequenos al√©m do Tailwind */
    .tab-btn { transition: all .18s ease; }
    .tab-active { transform: scale(1.03); box-shadow: 0 6px 18px rgba(16,185,129,.12); }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-green-50 to-yellow-50">

  <!-- Header -->
  <div class="bg-gradient-to-r from-green-700 via-red-600 to-yellow-500 text-white p-4 shadow-lg">
    <div class="max-w-6xl mx-auto text-center">
      <h1 class="text-2xl font-bold">üè¥ Sistema de Vendas - Cerim√¥nia Farroupilha üè¥</h1>
      <p class="text-sm opacity-90">Cap√≠tulo Bag√© n¬∫ 91 - Ordem DeMolay | <span id="eventDate"></span></p>
      <div class="grid grid-cols-3 gap-4 mt-4">
        <div class="bg-white/20 rounded-lg p-2">
          <div id="totalRevenue" class="text-lg font-bold">R$ 0,00</div>
          <div class="text-xs">Faturamento</div>
        </div>
        <div class="bg-white/20 rounded-lg p-2">
          <div id="totalSales" class="text-lg font-bold">0</div>
          <div class="text-xs">Vendas</div>
        </div>
        <div class="bg-white/20 rounded-lg p-2">
          <div id="totalItemsSold" class="text-lg font-bold">0</div>
          <div class="text-xs">Itens Vendidos</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main -->
  <div class="max-w-6xl mx-auto p-4">
    <!-- Tabs -->
    <div id="tabs" class="flex justify-center gap-2 mb-6">
      <button class="tab-btn bg-green-600 text-white px-4 py-2 rounded-lg transform hover:scale-105" data-tab="vendas" onclick="showTab('vendas')">Vendas</button>
      <button class="tab-btn bg-white px-4 py-2 rounded-lg border transform hover:scale-105" data-tab="estoque" onclick="showTab('estoque')">Estoque</button>
      <button class="tab-btn bg-white px-4 py-2 rounded-lg border transform hover:scale-105" data-tab="relatorios" onclick="showTab('relatorios')">Relat√≥rios</button>
    </div>

    <!-- Vendas -->
    <div id="tab-vendas" class="grid lg:grid-cols-3 gap-6">
      <!-- Produtos -->
      <div class="lg:col-span-2">
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h2 class="text-xl font-bold mb-4 text-green-800">Produtos Dispon√≠veis</h2>
          <div id="productList" class="grid sm:grid-cols-2 gap-4"></div>
        </div>
      </div>
      <!-- Carrinho -->
      <div class="bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-xl font-bold mb-4 text-green-800">Carrinho (<span id="cartCount">0</span> itens)</h2>
        <div id="cartItems" class="space-y-3 mb-6"></div>
        <div class="border-t pt-4">
          <div class="flex justify-between text-lg font-bold mb-4">
            <span>Total:</span>
            <span id="cartTotal" class="text-green-600">R$ 0,00</span>
          </div>
          <button onclick="completeSale()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold">Finalizar Venda</button>
        </div>
      </div>
    </div>

    <!-- Estoque -->
    <div id="tab-estoque" class="hidden bg-white rounded-xl shadow-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-green-800">Controle de Estoque</h2>
        <button onclick="resetData()" class="px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600">Resetar Dados</button>
      </div>
      <table class="w-full border">
        <thead class="bg-gray-50">
          <tr>
            <th class="p-2 text-left">Produto</th>
            <th class="p-2 text-center">Pre√ßo</th>
            <th class="p-2 text-center">Estoque</th>
            <th class="p-2 text-center">Vendidos</th>
            <th class="p-2 text-center">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="stockTable"></tbody>
      </table>
    </div>

    <!-- Relat√≥rios -->
    <div id="tab-relatorios" class="hidden bg-white rounded-xl shadow-lg p-6">
      <h2 class="text-xl font-bold mb-4 text-green-800">Relat√≥rios</h2>
      <div id="reportList" class="space-y-3"></div>
    </div>
  </div>

  <!-- Service Worker registration (PWA) -->
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js").then(() => console.log("SW registrado"));
    }
  </script>

  <script>
    // ======= Dados iniciais (n√£o modificar diretamente) =======
    const INITIAL_PRODUCTS = [
      { id: 1, name: '√Ågua s/ G√°s 500ml', price: 2.00, stock: 100, sold: 0 },
      { id: 2, name: '√Ågua c/ G√°s 500ml', price: 3.00, stock: 50, sold: 0 },
      { id: 3, name: 'Refrigerante 350ml', price: 5.00, stock: 60, sold: 0 },
      { id: 4, name: 'Amstel 350ml', price: 6.00, stock: 40, sold: 0 },
      { id: 5, name: 'Vinho Ideologia Assemblage Batalha', price: 50.00, stock: 20, sold: 0 },
      { id: 6, name: 'Espumante Nature Forte Santa Tecla', price: 70.00, stock: 10, sold: 0 }
    ];

    // ======= Estado =======
    let products = [];
    let sales = [];
    let cart = [];

    const STORAGE_KEY = 'farroupilha-data';

    // Data load/save
    function loadData() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try {
          const parsed = JSON.parse(raw);
          // se tiver produtos salvos usa, sen√£o inicial
          products = (parsed.products && Array.isArray(parsed.products)) ? parsed.products : JSON.parse(JSON.stringify(INITIAL_PRODUCTS));
          sales = Array.isArray(parsed.sales) ? parsed.sales : [];
        } catch (e) {
          console.error('Erro ao ler storage:', e);
          products = JSON.parse(JSON.stringify(INITIAL_PRODUCTS));
          sales = [];
        }
      } else {
        products = JSON.parse(JSON.stringify(INITIAL_PRODUCTS));
        sales = [];
      }

      // sanitiza e evita negativos
      products.forEach(p => {
        p.stock = Math.max(0, Number(p.stock) || 0);
        p.sold = Math.max(0, Number(p.sold) || 0);
        p.price = Number(p.price) || 0;
      });
      sales = sales.map(s => {
        s.total = Number(s.total) || 0;
        s.items = Array.isArray(s.items) ? s.items.map(it => ({ ...it, quantity: Number(it.quantity) || 0 })) : [];
        return s;
      });
    }

    function saveData() {
      const payload = { products, sales };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    }

    // ======= Utils =======
    function formatMoney(v){ return "R$ " + Number(v || 0).toFixed(2); }

    // ======= Render Produtos (Vendas) =======
    function renderProducts() {
      const list = document.getElementById("productList");
      list.innerHTML = "";
      products.forEach(p => {
        const disabled = p.stock <= 0 ? 'disabled' : '';
        list.innerHTML += `
          <div class="border rounded-lg p-4 ${p.stock === 0 ? 'opacity-50' : 'bg-white'}">
            <div class="flex justify-between mb-2">
              <h3 class="font-medium">${p.name}</h3>
              <span class="font-bold text-green-600">${formatMoney(p.price)}</span>
            </div>
            <p class="text-sm text-gray-600 mb-3">Estoque: <span id="prod-stock-${p.id}">${p.stock}</span></p>
            <button ${disabled} onclick="addToCart(${p.id})" class="mt-2 w-full ${disabled ? 'bg-gray-300 text-gray-600 cursor-not-allowed' : 'bg-green-600 text-white hover:bg-green-700'} py-2 rounded">
              ${p.stock === 0 ? 'Sem Estoque' : 'Adicionar'}
            </button>
          </div>
        `;
      });
    }

    // ======= Carrinho =======
    function addToCart(id) {
      const product = products.find(p => p.id === id);
      if (!product || product.stock <= 0) return;
      const existing = cart.find(i => i.id === id);
      if (existing) {
        // limita a quantidade ao estoque dispon√≠vel
        if (existing.quantity + 1 > product.stock) {
          alert('Quantidade maior que o estoque dispon√≠vel.');
          return;
        }
        existing.quantity++;
      } else {
        cart.push({ id: product.id, name: product.name, price: product.price, quantity: 1 });
      }
      renderCart();
    }

    function changeQuantity(id, delta) {
      const item = cart.find(i => i.id === id);
      if (!item) return;
      const product = products.find(p => p.id === id);
      if (!product) return;
      if (delta > 0 && item.quantity + delta > product.stock) {
        alert('Quantidade maior que o estoque dispon√≠vel.');
        return;
      }
      item.quantity += delta;
      if (item.quantity <= 0) {
        cart = cart.filter(i => i.id !== id);
      }
      renderCart();
    }

    function setQuantity(id, qty) {
      const item = cart.find(i => i.id === id);
      const product = products.find(p => p.id === id);
      if (!item || !product) return;
      const q = Math.max(0, Math.floor(Number(qty) || 0));
      if (q > product.stock) { alert('Quantidade maior que o estoque dispon√≠vel.'); return; }
      if (q === 0) cart = cart.filter(i => i.id !== id);
      else item.quantity = q;
      renderCart();
    }

    function removeFromCart(id) {
      cart = cart.filter(i => i.id !== id);
      renderCart();
    }

    function renderCart() {
      const cartItems = document.getElementById("cartItems");
      const cartCount = document.getElementById("cartCount");
      const cartTotal = document.getElementById("cartTotal");
      cartItems.innerHTML = "";
      let total = 0, count = 0;
      cart.forEach(item => {
        total += item.price * item.quantity;
        count += item.quantity;
        cartItems.innerHTML += `
          <div class="flex justify-between items-center bg-gray-50 p-2 rounded">
            <div class="flex-1">
              <div class="font-medium text-sm">${item.name}</div>
              <div class="text-xs text-gray-600">R$ ${item.price.toFixed(2)} x 
                <input type="number" min="0" value="${item.quantity}" oninput="setQuantity(${item.id}, this.value)" class="w-20 ml-1 border rounded px-1 py-0.5 text-sm inline"/>
              </div>
            </div>
            <div class="flex items-center gap-2 ml-4">
              <button onclick="changeQuantity(${item.id}, -1)" class="px-2 bg-red-500 text-white rounded">-</button>
              <div class="font-bold">${item.quantity}</div>
              <button onclick="changeQuantity(${item.id}, 1)" class="px-2 bg-green-500 text-white rounded">+</button>
              <button onclick="removeFromCart(${item.id})" class="ml-2 px-2 bg-gray-600 text-white rounded">x</button>
            </div>
            <div class="ml-3 font-bold text-green-600">R$ ${(item.price * item.quantity).toFixed(2)}</div>
          </div>
        `;
      });
      cartCount.innerText = count;
      cartTotal.innerText = formatMoney(total);
    }

    // ======= Finalizar venda =======
    function completeSale() {
      if (cart.length === 0) { alert('Carrinho vazio.'); return; }
      // checagem r√°pida de estoque antes de finalizar
      for (const item of cart) {
        const p = products.find(pr => pr.id === item.id);
        if (!p || item.quantity > p.stock) {
          alert(`Estoque insuficiente para ${item.name}.`);
          return;
        }
      }

      const total = cart.reduce((s, it) => s + it.price * it.quantity, 0);
      const sale = {
        id: Date.now(),
        timestamp: new Date().toLocaleString('pt-BR'),
        items: cart.map(i => ({ id: i.id, name: i.name, price: i.price, quantity: i.quantity })),
        total: Number(total.toFixed(2))
      };

      // atualizar estoque e vendidos
      sale.items.forEach(it => {
        const p = products.find(pr => pr.id === it.id);
        if (p) {
          p.stock = Math.max(0, Number(p.stock) - Number(it.quantity));
          p.sold = Math.max(0, Number(p.sold) + Number(it.quantity));
        }
      });

      sales.push(sale);
      saveData();
      cart = [];
      renderProducts();
      renderCart();
      renderStats();
      alert(`Venda conclu√≠da! Total ${formatMoney(sale.total)}`);
    }

    // ======= Estoque (alterar manualmente) =======
    function renderStock() {
      const table = document.getElementById("stockTable");
      table.innerHTML = "";
      products.forEach(p => {
        table.innerHTML += `
          <tr class="border-b hover:bg-gray-50">
            <td class="p-2">${p.name}</td>
            <td class="p-2 text-center">${formatMoney(p.price)}</td>
            <td class="p-2 text-center">
              <div class="inline-flex items-center gap-2">
                <button onclick="updateStock(${p.id}, ${p.stock} - 1)" class="px-2 py-1 bg-red-100 rounded">-</button>
                <input id="stock-input-${p.id}" type="number" class="w-20 text-center border rounded px-2 py-1" value="${p.stock}" min="0" oninput="updateStock(${p.id}, this.value)"/>
                <button onclick="updateStock(${p.id}, ${p.stock} + 1)" class="px-2 py-1 bg-green-100 rounded">+</button>
              </div>
            </td>
            <td class="p-2 text-center font-semibold text-blue-600">${p.sold}</td>
            <td class="p-2 text-center">
              <button onclick="resetProduct(${p.id})" class="px-2 py-1 bg-yellow-500 text-white rounded">Reset</button>
            </td>
          </tr>
        `;
      });
    }

    function updateStock(id, value) {
      const p = products.find(pr => pr.id === id);
      if (!p) return;
      const newStock = Math.max(0, Math.floor(Number(value) || 0));
      p.stock = newStock;
      // atualiza input exibido (caso value program√°tico)
      const input = document.getElementById(`stock-input-${id}`);
      if (input) input.value = newStock;
      saveData();
      renderProducts();
      renderStock();
      renderStats();
    }

    // Restaura produto ao estado inicial (opcional)
    function resetProduct(id) {
      const p = products.find(pr => pr.id === id);
      const initial = INITIAL_PRODUCTS.find(ip => ip.id === id);
      if (!p || !initial) return;
      if (!confirm(`Resetar "${p.name}" para estoque inicial (${initial.stock}) e vendidos 0?`)) return;
      p.stock = initial.stock;
      p.sold = 0;
      saveData();
      renderProducts();
      renderStock();
      renderStats();
    }

    // ======= Relat√≥rios =======
    function renderReports() {
      const div = document.getElementById("reportList");
      div.innerHTML = "";
      if (sales.length === 0) {
        div.innerHTML = `<p class="text-center text-gray-500 py-8">Nenhuma venda registrada ainda.</p>`;
        return;
      }
      sales.forEach((s, idx) => {
        div.innerHTML += `
          <div class="border rounded-lg p-3 flex justify-between items-start gap-4">
            <div class="flex-1">
              <div class="flex justify-between items-center mb-2">
                <div class="font-semibold">Venda #${idx+1} <span class="text-xs text-gray-500 ml-2">${s.timestamp || ''}</span></div>
                <div class="font-bold text-green-600">${formatMoney(s.total)}</div>
              </div>
              <div class="text-sm text-gray-700 space-y-1">
                ${s.items.map(it => `<div>${it.name} x ${it.quantity} ‚Äî R$ ${(it.price * it.quantity).toFixed(2)}</div>`).join('')}
              </div>
            </div>
            <div class="flex flex-col gap-2">
              <button onclick="removeSale(${idx})" class="px-3 py-1 bg-red-500 text-white rounded">Remover</button>
            </div>
          </div>
        `;
      });
    }

    function removeSale(index) {
      if (!confirm('Remover esta venda? O estoque ser√° ajustado automaticamente.')) return;
      const sale = sales[index];
      if (!sale) return;
      // devolve estoque e ajusta vendidos (clamp >= 0)
      sale.items.forEach(item => {
        const p = products.find(pr => pr.id === item.id);
        if (p) {
          p.stock = Math.max(0, Number(p.stock) + Number(item.quantity));
          p.sold = Math.max(0, Number(p.sold) - Number(item.quantity));
        }
      });
      sales.splice(index, 1);
      saveData();
      renderProducts();
      renderReports();
      renderStock();
      renderStats();
    }

    // ======= Stats =======
    function renderStats() {
      const totalRevenue = sales.reduce((sum, s) => sum + Number(s.total || 0), 0);
      const totalItems = products.reduce((sum, p) => sum + Math.max(0, Number(p.sold || 0)), 0);
      document.getElementById("totalRevenue").innerText = formatMoney(totalRevenue);
      document.getElementById("totalSales").innerText = sales.length;
      document.getElementById("totalItemsSold").innerText = totalItems;
    }

    // ======= Tabs UI =======
    function setActiveTabButton(tabKey) {
      const buttons = document.querySelectorAll('#tabs .tab-btn');
      buttons.forEach(btn => {
        if (btn.dataset.tab === tabKey) {
          btn.classList.add('tab-active','bg-green-600','text-white');
          btn.classList.remove('bg-white','border','text-gray-700');
        } else {
          btn.classList.remove('tab-active');
          btn.classList.remove('bg-green-600','text-white');
          btn.classList.add('bg-white','border','text-gray-700');
        }
      });
    }

    function showTab(tab) {
      ['vendas','estoque','relatorios'].forEach(t => {
        const node = document.getElementById('tab-'+t);
        if (node) node.classList.add('hidden');
      });
      const node = document.getElementById('tab-'+tab);
      if (node) node.classList.remove('hidden');

      setActiveTabButton(tab);

      if (tab === 'estoque') renderStock();
      if (tab === 'relatorios') renderReports();
    }

    // Resetar todos os dados para valores iniciais
    function resetData() {
      if (!confirm('Resetar TODOS os dados para o padr√£o? Estoque e vendas ser√£o perdidos.')) return;
      products = JSON.parse(JSON.stringify(INITIAL_PRODUCTS));
      sales = [];
      cart = [];
      saveData();
      renderProducts();
      renderCart();
      renderStock();
      renderReports();
      renderStats();
    }

    // ======= Inicializa√ß√£o =======
    document.getElementById("eventDate").innerText = new Date().toLocaleDateString("pt-BR");
    loadData();
    renderProducts();
    renderCart();
    renderStats();
    // start in vendas tab
    showTab('vendas');

    // Salva automaticamente sempre que a aba √© fechada (fim de sess√£o)
    window.addEventListener('beforeunload', saveData);
  </script>
</body>
</html>
